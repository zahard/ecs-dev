!function(e){var t={};function s(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)s.d(i,r,function(t){return e[t]}.bind(null,r));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t,s){"use strict";function i(e,t){return{x:t.x-e.x,y:t.y-e.y}}function r(e,t){if(t<e){const s=t;t=e,e=s}const s=[];for(let i=e;i<=t;i++)s.push(i);return s}s.r(t);class n{constructor(e){this.animation=e,this.frameIndex=0,this.timeToFrameChange=0,this._isFinished=!1,this.drawedOnce=!1,this.setAnimation(e)}setAnimation(e){this.animation=e,this.frameIndex=0,this.timeToFrameChange=0,this._isFinished=!1,this.drawedOnce=!1}isFrameStarted(e){return this.frameIndex===e&&this.animation.frameDelay===this.timeToFrameChange}isActive(){return!this._isFinished}isFinished(){return this._isFinished}getFrameIndex(){return this.frameIndex}animationFrame(){return this.animation.frames[this.frameIndex]}timeToFrame(){return this.timeToFrameChange}tick(e){return!this._isFinished&&(this.timeToFrameChange-=e,!(this.timeToFrameChange>0)&&(!this.drawedOnce||(this.timeToFrameChange=this.animation.frameDelay,this.frameIndex<this.animation.frames.length-1?this.frameIndex+=1:this.animation.isLooped?this.frameIndex=0:this._isFinished=!0,!0)))}drawFrame(e,t,s){this.drawedOnce||(this.drawedOnce=!0);const{x:i,y:r}=function(e,t){const s=e,i=Math.floor(t/s.framesPerRow),r=t%s.framesPerRow;return{x:s.offsetX+r*(s.frameW+s.padX),y:s.offsetY+i*(s.frameH+s.padY)}}(this.animation.sprite,this.animationFrame()),n=this.animation.sprite;s?(e.save(),e.translate(t.x-n.frameW/2,t.y-n.frameH),e.scale(-1,1),e.drawImage(n.handle,i,r,n.frameW,n.frameH,-n.frameW,0,n.frameW,n.frameH),e.setTransform(1,0,0,1,0,0)):e.drawImage(n.handle,i,r,n.frameW,n.frameH,t.x-n.frameW/2,t.y-n.frameH,n.frameW,n.frameH)}}class a{constructor(e,t){this.worldRules={physics:!1,spriteAnimation:!0},this.pos={x:0,y:0},this.speed={x:0,y:0},this.spriteDir=1,this.deleteNextTick=!1,this.spriteDir=t;const s={handle:e,offsetY:830,offsetX:27,padY:0,padX:0,framesPerRow:9,frameH:52,frameW:52};this.spritePlayer=new n({sprite:s,frames:r(6,21),frameDelay:40,isLooped:!1})}tick(e,t,s){return this.spritePlayer.isFinished()?(this.deleteNextTick=!0,!1):this.spritePlayer.tick(e)}draw(e,t){const s=i(t,this.pos);this.spritePlayer.drawFrame(e,s,-1!==this.spriteDir)}setPosition(e){this.pos=e}}class o{constructor(e,t){this.worldRules={physics:!0,spriteAnimation:!0},this.pos={x:0,y:0},this.speed={x:0,y:0},this.spriteDir=1,this.deleteNextTick=!1,this.spriteDir=t;const s={handle:e,offsetY:830,offsetX:27,padY:0,padX:0,framesPerRow:9,frameH:52,frameW:52};this.spritePlayer=new n({sprite:s,frames:r(22,25),frameDelay:200,isLooped:!0})}tick(e,t,s){const r=i(s.worldOffset,this.pos);return(r.x<0||r.x>720)&&(console.log(s.worldOffset,this.pos),console.log(r.x),this.deleteNextTick=!0),this.spritePlayer.tick(e)}draw(e,t){const s=i(t,this.pos);this.spritePlayer.drawFrame(e,s,-1!==this.spriteDir)}setSpeed(e){this.speed.x=e}setPosition(e){this.pos=e}}var h;!function(e){e[e.Idle=0]="Idle",e[e.Driving=1]="Driving",e[e.Jump=2]="Jump",e[e.Shooting=3]="Shooting",e[e.Lean=4]="Lean"}(h||(h={}));class d{constructor(e,t){this.worldRules={physics:!0,spriteAnimation:!0},this.pos={x:0,y:0},this.inAir=!1,this.speed={x:0,y:0},this.spriteDir=1,this.needRedraw=!1,this.jumpSpeed=-10,this.tickHandlers={[h.Idle]:()=>this.tickIdle,[h.Driving]:()=>this.tickDriving,[h.Jump]:()=>this.tickJump,[h.Lean]:()=>this.tickLean,[h.Shooting]:()=>this.tickShooting},this.stateAnimations=this.builsStatesAnimations(e),this.spritePlayer=new n(this.getAnimation(h.Idle)),this.setState(t)}tick(e,t,s){this.needRedraw=!1;return this.tickHandlers[this.currentState]().call(this,t,e,s),this.spritePlayer.tick(e)&&(this.needRedraw=!0),this.needRedraw}draw(e,t){const s=i(t,this.pos);this.spritePlayer.drawFrame(e,s,-1!==this.spriteDir)}tickShooting(e,t,s){this.spritePlayer.isFrameStarted(5)?this.shootProjectile(s):this.spritePlayer.isFinished()&&this.setState(h.Idle)}tickLean(e,t,s){if(!1!==this.inAir)if(e.keyPressed("KeyA")||e.keyPressed("KeyD")){e.keyPressed("KeyD")&&(this.spriteDir=1),e.keyPressed("KeyA")&&(this.spriteDir=-1),e.keyWasPressed("Space")&&this.shootProjectile(s);const i=40/t;this.speed.x=i*this.spriteDir}else this.speed.x=0,this.setState(h.Jump);else this.setState(h.Driving)}tickJump(e,t,s){this.inAir||this.setState(h.Idle),e.keyPressed("KeyA")?(this.spriteDir=-1,this.setState(h.Lean)):e.keyPressed("KeyD")&&(this.spriteDir=1,this.setState(h.Lean)),e.keyWasPressed("Space")&&this.shootProjectile(s)}tickDriving(e,t){if(e.keyPressed("KeyA")||e.keyPressed("KeyD")){e.keyPressed("KeyW")&&(this.speed.y=this.jumpSpeed,this.inAir=!0,this.setState(h.Jump)),e.keyPressed("KeyD")&&(this.spriteDir=1),e.keyPressed("KeyA")&&(this.spriteDir=-1);const s=50/t;this.speed.x=s*this.spriteDir}else this.speed.x=0,this.setState(h.Idle)}tickIdle(e){e.keyPressed("KeyA")?(this.spriteDir=-1,this.setState(h.Driving)):e.keyPressed("KeyD")?(this.spriteDir=1,this.setState(h.Driving)):e.keyWasPressed("Space")?this.setState(h.Shooting):e.keyWasPressed("KeyW")&&(this.speed.y=this.jumpSpeed,this.inAir=!0,this.setState(h.Jump))}shootProjectile(e){const t=new a(e.resources.tank,this.spriteDir);t.setPosition({x:this.pos.x+60*this.spriteDir,y:this.pos.y-20});const s=new o(e.resources.tank,this.spriteDir);s.setPosition({x:this.pos.x+60*this.spriteDir,y:this.pos.y-10}),s.setSpeed(5*this.spriteDir),e.spawnObject(s),e.spawnObject(t)}setPosition(e){this.pos=e}setState(e){this.needRedraw=!0,this.currentState=e,this.spritePlayer.setAnimation(this.getAnimation(this.currentState))}getAnimation(e){return this.stateAnimations[e]}builsStatesAnimations(e){const t={handle:e,offsetY:30,offsetX:0,padY:1,padX:3,framesPerRow:6,frameH:58,frameW:72},s=Object.assign(Object.assign({},t),{padY:3}),i=Object.assign(Object.assign({},t),{offsetX:2,offsetY:12,padY:0,padX:0,frameH:62,frameW:74});return{[h.Driving]:{sprite:t,frames:r(6,11),frameDelay:100,isLooped:!0},[h.Shooting]:{sprite:i,frames:r(36,45),frameDelay:60,isLooped:!1},[h.Idle]:{sprite:t,frames:r(0,3),frameDelay:150,isLooped:!0},[h.Jump]:{sprite:s,frames:[51],frameDelay:1e3,isLooped:!0},[h.Lean]:{sprite:s,frames:[51],frameDelay:1e3,isLooped:!0}}}}const p={keys:{},init(){window.addEventListener("keydown",e=>{this.onKeyDown(e.code)}),window.addEventListener("keyup",e=>{this.onKeyUp(e.code)})},keyPressStatus:()=>({isPressed:!0,wasPressed:!1}),keyUpStatus:()=>({isPressed:!1,wasPressed:!0}),afterTick(){Object.values(this.keys).forEach(e=>e.wasPressed=!1)},onKeyDown(e){this.keys[e]=this.keyPressStatus()},onKeyUp(e){this.keys[e]=this.keyUpStatus()},keyPressed(e){var t;return(null===(t=this.keys[e])||void 0===t?void 0:t.isPressed)||!1},keyReleased(e){var t;return!(null===(t=this.keys[e])||void 0===t?void 0:t.isPressed)},keyWasPressed(e){return!!this.keys[e]&&this.keys[e].wasPressed}};function c(e,t,s,i){return function(){if(t.push({name:e,img:this}),t.length==s.length){const e={};t.forEach(t=>e[t.name]=t.img),i(e)}}}!function(e,t){for(var s=[],i=0;i<e.length;i++)(i=>{var r=e[i],n=new window.Image,a=r.name;n.onload=c(a,s,e,t),n.src=r.path})(i)}([{name:"tank",path:"/assets/tank.png"},{name:"level_1",path:"/assets/level_1.png"}],(function(e){const t=e.tank;console.log(e.level_1.width,e.level_1.height);const s=function(e){const t=window.document.createElement("canvas");t.width=e.width,t.height=e.height;const s=t.getContext("2d");s.drawImage(e,0,0);const i=s.getImageData(0,0,t.width,t.height),r=i.data;for(let e=0;e<r.length;e+=4)r[e]>235&&r[e+1]>235&&r[e+2]>235&&(r[e+3]=0),r[e]<2&&128===r[e+1]&&r[e+2]<2&&(r[e+3]=0);return s.putImageData(i,0,0),t}(t),i=window.document.getElementById("canvas");i.width=480,i.height=240;const r=i.getContext("2d");r.imageSmoothingEnabled=!1,r.clearRect(0,0,i.width,i.height),p.init();let n=0,a=!1;const o=[],c=[];let m=0;const f=e=>{c.push(e)},l=new d(s,h.Idle);l.setPosition({x:100,y:200}),f(l);const y=l,u={spawnObject:f,resources:{tank:s},worldOffset:{x:m,y:0}};function w(t){const s=t-n;if(n=t,p.keyWasPressed("Escape")&&(a=!a),a)return p.afterTick(),void window.requestAnimationFrame(w);let h=!1;const d=e=>{h=h||e};d(function(e){const t=e.filter(e=>e.deleteNextTick);if(!t.length)return!1;return t.forEach(t=>{const s=e.indexOf(t);e.splice(s,1)}),!0}(o)),c.length&&(o.push(...c),c.length=0),o.forEach(e=>{d(e.tick(s,p,u))}),o.filter(e=>!!e.worldRules.physics).forEach(e=>{d(function(e,t){let s=!1;0!==e.speed.x&&(e.pos.x+=e.speed.x,s=!0);0!==e.speed.y&&(e.pos.y+=e.speed.y,e.speed.y+=.4,e.pos.y>=200&&(e.pos.y=200,e.speed.y=0,e.inAir=!1),s=!0);return s}(e))});const f=y.pos.x;f>240&&(m=f-240),u.worldOffset.x=m,h&&(r.clearRect(0,0,i.width,i.height),r.drawImage(e.level_1,m,0,i.width,i.height,0,0,i.width,i.height),o.forEach(e=>{e.draw(r,{x:m,y:0})})),p.afterTick(),window.requestAnimationFrame(w)}window.requestAnimationFrame(e=>w(e))}))}]);